function resize_svg(t,e){const a=d3.select("#"+t+" svg").node(),o=a.viewBox.baseVal.width,n=a.viewBox.baseVal.height,r=d3.select("#"+t+" svg g").node().getBBox(),i=o/2-(r.x+r.width/2)*e,s=n/2-(r.y+r.height/2)*e;d3.select("#"+t+" svg g").attr("transform",`translate(${i}, ${s}) scale(${e})`)}function scale_svgs(t,e,a){if(2===e){let e=t[0],o=t[1];if(console.log(e,o),e<1&&o<1){const t=Math.max(e,o);if(e<t){resize_svg(a+"-1",e/t)}else if(o<t){resize_svg(a+"-2",o/t)}}}else if(3===e){let e=t[0],o=t[1],n=t[2];if(console.log(e,o,n),e<1&&o<1&&n<1){const t=Math.max(e,o,n);if(e<t){resize_svg(a+"-1",e/t)}if(o<t){resize_svg(a+"-2",o/t)}if(n<t){resize_svg(a+"-3",n/t)}}}}export const tab_create_viz=(t,e)=>{if("tab2"===e){clearVisualization(t+"-1");create_viz(t+"-1","tb2-text-input","tb2-sidebar")}else if("tab3"===e){clearVisualization(t+"-1"),clearVisualization(t+"-2"),null!==(a=document.getElementById("tb3-visualization-combined-export-btn"))&&a.remove(),scale_svgs([create_viz(t+"-1","tb3-text-input-1","tb3-sidebar-1"),create_viz(t+"-2","tb3-text-input-2","tb3-sidebar-2")],2,t),addDownloadCombinedButton(t,t+"-1")}else if("tab4"===e){var a;clearVisualization(t+"-1"),clearVisualization(t+"-2"),clearVisualization(t+"-3"),null!==(a=document.getElementById("tb4-visualization-combined-export-btn"))&&a.remove(),scale_svgs([create_viz(t+"-1","tb4-text-input-1","tb4-sidebar-1"),create_viz(t+"-2","tb4-text-input-2","tb4-sidebar-2"),create_viz(t+"-3","tb4-text-input-3","tb4-sidebar-3")],3,t),addDownloadCombinedButton(t,t+"-1",3)}};function darkenColor(t){const e=d3.hsl(t);e.l-=.2,e.l=Math.max(0,Math.min(1,e.l));return d3.rgb(e).toString()}const visualizations=document.querySelectorAll(".visualization");visualizations.forEach((t=>{t.style.display="none"}));const clearVisualization=t=>{const e=document.querySelector("#"+t);for(;e.firstChild;)e.removeChild(e.firstChild)};function getPaddedBBox(t,e){const a=t.getBBox();return{x:a.x-e,y:a.y-e,width:a.width+2*e,height:a.height+2*e}}const findNonOverlappingRegion=(t,e,a,o,n,r,i,s)=>{const l=3.5*r,c=t.selectAll("text").filter((function(){return this!==s}));let d=a+l,u=a-l,h=e-o/2;const x=t=>{let e=0;return c.each((function(){const a=getPaddedBBox(this,i);h+o>a.x&&h<a.x+a.width&&(t+n>a.y&&t<a.y+a.height||t-n>a.y&&t-n<a.y+a.height)&&e++})),e},g=x(d),y=x(u),p=g===y?Math.random()<.5?d:u:g<y?d:u;return{x:h,y:p}},create_viz=(t,e,a,o=40,n=600,r=335)=>{const i=document.querySelector("#"+e),s=document.querySelector("#"+a),l=d3.select("#"+t).append("svg").attr("width","100%").attr("height","100%").attr("viewBox","0 0 "+n+" "+r).attr("preserveAspectRatio","xMidYMid meet"),c=l.append("g"),d=Array.from(i.childNodes),u=s.querySelectorAll('.item-wrapper:not([data-type="horizontal-line"])'),h={};u.forEach((t=>{const e=t.querySelector(".color-index-container").id.slice(-6),a=t.querySelectorAll(".color-description-input"),o=t.querySelectorAll(".description-dropdown"),n=Array.from(a).map(((t,e)=>`${""!=o[e].value?o[e].value+": ":""} ${t.value}`.trim())).join("\n");h[e]=n}));let x=0,g=20;const y=10*o,p=new Set,f=[],m=[];d.forEach(((t,e)=>{if(t.nodeType===Node.TEXT_NODE){t.textContent.split(" ").forEach((t=>{const e=c.append("text").attr("x",-9999).attr("y",-9999).text(t),a=e.node().getComputedTextLength();e.remove();x+a>y&&(x=0,g+=35);c.append("text").attr("x",x).attr("y",g).text(t);f.push(x),x+=a+5}))}else if(t.nodeType===Node.ELEMENT_NODE){const e=t,a=e.className.slice(-6),o=e.className.includes("color-highlight"),n=e.className.includes("strikethrough"),r=e.textContent.split(" "),i=Math.floor((r.length+1)/2)-1;let s;r.forEach(((t,e)=>{const r=c.append("text").attr("x",-9999).attr("y",-9999).text(t),l=r.node().getComputedTextLength();r.remove();x+l>y&&(x=0,g+=35),e===i&&(s=x);c.append("text").attr("x",x).attr("y",g).text(t).style("pointer-events","none");if(e===i&&(s=x+l/2),o){c.insert("rect","text").attr("x",x-3).attr("y",g-15).attr("width",l+6).attr("height",20).attr("fill",`#${a}`)}if(n){c.insert("line","text").attr("x1",x-3).attr("y1",g-5).attr("x2",x+l+2).attr("y2",g-5).attr("stroke",`#${a}`).attr("stroke-width",2)}x+=l+5})),h[a]&&!p.has(e)&&(p.add(e),m.push({color:a,middleWordX:s,currentY:g,annotationLines:h[a].split("\n")}))}})),m.filter((({annotationLines:t})=>t.some((t=>""!==t.trim())))).forEach((({color:t,middleWordX:e,currentY:a,annotationLines:o})=>{const n=c.append("g").on("mouseover",(function(){showDragHandles(d3.select(this))})).on("mouseout",(function(){hideDragHandles(d3.select(this))})).on("touchstart",(function(){showDragHandles(d3.select(this))})),r=n.append("text").attr("x",e-6).attr("y",a).style("fill",darkenColor(`#${t}`)).style("font-size","14px").style("pointer-events","none");o.forEach(((t,a)=>{r.append("tspan").text(t).attr("x",e-6).attr("dy",0===a?0:20)}));const i=getPaddedBBox(r.node(),5),s=findNonOverlappingRegion(c,e,a,i.width,i.height,20,5,r.node());r.attr("x",s.x).attr("y",s.y),r.selectAll("tspan").attr("x",s.x);const l=getPaddedBBox(r.node(),5),d=l.x,u=l.x+l.width,h=l.y,x=l.y+l.height,g=e,y=a,p=[{x:d,y:(h+x)/2},{x:u,y:(h+x)/2},{x:(d+u)/2,y:h},{x:(d+u)/2,y:x}].reduce(((t,e)=>{const a=Math.sqrt(Math.pow(t.x-g,2)+Math.pow(t.y-y,2));return Math.sqrt(Math.pow(e.x-g,2)+Math.pow(e.y-y,2))<a?e:t})),f=n.append("line").attr("x1",e-6).attr("y1",a).attr("x2",p.x).attr("y2",p.y).attr("stroke",darkenColor(`#${t}`)).attr("stroke-width",1.5),m=n.append("circle").attr("cx",p.x).attr("cy",p.y).attr("r",3).attr("fill",darkenColor(`#${t}`));s.y<a?r.attr("y",parseFloat(r.attr("y"))-5):r.attr("y",parseFloat(r.attr("y"))+5);const w=n.append("circle").attr("class","drag-handle draggable").attr("cx",p.x).attr("cy",p.y).attr("r",4).attr("fill","blue").style("cursor","move").style("display","none");w.call(createDragBehavior(((t,e)=>{w.attr("cx",parseFloat(w.attr("cx"))+t).attr("cy",parseFloat(w.attr("cy"))+e);const a=parseFloat(r.attr("x"))+t,o=parseFloat(r.attr("y"))+e;r.attr("x",a).attr("y",o),r.selectAll("tspan").attr("x",a),f.attr("x2",parseFloat(f.attr("x2"))+t).attr("y2",parseFloat(f.attr("y2"))+e),m.attr("cx",parseFloat(m.attr("cx"))+t).attr("cy",parseFloat(m.attr("cy"))+e)}),(()=>{const t=getPaddedBBox(r.node(),5),e=t.x,a=t.x+t.width,o=t.y,n=t.y+t.height,i=[{x:e,y:(o+n)/2},{x:a,y:(o+n)/2},{x:(e+a)/2,y:o},{x:(e+a)/2,y:n}].reduce(((t,e)=>{const a=Math.sqrt(Math.pow(t.x-g,2)+Math.pow(t.y-y,2));return Math.sqrt(Math.pow(e.x-g,2)+Math.pow(e.y-y,2))<a?e:t}));f.attr("x2",i.x).attr("y2",i.y),m.attr("cx",i.x).attr("cy",i.y),w.attr("cx",i.x).attr("cy",i.y)})));const v=n.append("circle").attr("class","drag-handle draggable").attr("cx",e-6).attr("cy",a).attr("r",4).attr("fill","blue").style("cursor","move").style("display","none");v.call(createDragBehavior(((t,e)=>{f.attr("x1",parseFloat(f.attr("x1"))+t).attr("y1",parseFloat(f.attr("y1"))+e),v.attr("cx",parseFloat(v.attr("cx"))+t).attr("cy",parseFloat(v.attr("cy"))+e)}),(()=>{})))}));const w=c.node().getBBox(),v=`0 0 ${w.width+40} ${w.height+40}`;l.attr("viewBox",v);const b=20-w.x,B=20-w.y;return c.attr("transform",`translate(${b}, ${B})`),addDownloadButton(l,t),(w.width+40)/n};function createDragBehavior(t,e){let a,o;return d3.drag().on("start",(t=>{t.sourceEvent.stopPropagation(),a=t.x,o=t.y})).on("drag",(e=>{const n=e.x-a,r=e.y-o;a=e.x,o=e.y,t.call(this,n,r)})).on("end",e)}function showDragHandles(t){t.selectAll(".drag-handle").style("display","block")}function hideDragHandles(t){t.selectAll(".drag-handle").style("display","none")}function addDownloadButton(t,e){const a=document.getElementById(e),o=document.createElement("button");o.className="download-svg-btn",o.id=e+"-export-btn",o.innerHTML='\n  <i class="fas fa-file-download"></i>',o.onclick=()=>{downloadVisualization(t)},a.appendChild(o)}function addDownloadCombinedButton(t,e,a=2){const o=document.getElementById(e),n=document.createElement("button");n.className="download-svg-combined-btn",n.id=t+"-combined-export-btn";2==a?n.innerHTML='\n  <i class="fas fa-file-download"></i><i class="fas fa-plus"></i><i class="fas fa-file-download"></i>':3==a&&(n.innerHTML='\n  <i class="fas fa-file-download"></i><i class="fas fa-plus"></i><i class="fas fa-file-download"></i><i class="fas fa-plus"></i><i class="fas fa-file-download"></i>'),n.onclick=()=>{downloadCombinedVisualizations(t)},o.appendChild(n)}function downloadVisualization(t){const e=t.node().cloneNode(!0);includeStyles(e);const a=getSVGContentBoundingBox(t);e.setAttribute("viewBox",`${a.x} ${a.y} ${a.width} ${a.height}`);const o=(new XMLSerializer).serializeToString(e),n="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(o))),r=e.getAttribute("viewBox").split(" ").map(parseFloat),i=1200/(r[2]/r[3]),s=new Image;s.src=n;const l=document.createElement("canvas");l.width=1200,l.height=i;const c=l.getContext("2d");s.onload=()=>{c.drawImage(s,0,0,l.width,l.height);const t=l.toDataURL("image/png"),e=document.createElement("a");e.href=t,e.download="visualization.png",e.click()}}function includeStyles(t){const e=document.styleSheets,a=document.createElement("style");let o="";for(const t of e){let e;try{e=t.rules||t.cssRules}catch(t){continue}for(const t of e)o+=`${t.cssText}\n`}a.innerHTML=o,t.insertBefore(a,t.firstChild)}function getSVGContentBoundingBox(t){return t.select("g").node().parentNode.getBBox()}function downloadCombinedVisualizations(t){const e=document.getElementById(t),a=Array.from(e.querySelectorAll(".subvisualization")),o=600,n=335*a.length,r=document.createElement("canvas");r.width=o,r.height=n;const i=r.getContext("2d");let s=0;a.forEach(((t,e)=>{const n=t.querySelector("svg"),l=n.cloneNode(!0),c=n.clientWidth,d=n.clientHeight*(o/c);l.setAttribute("width",o),l.setAttribute("height",d),console.log(l);const u=new Image;u.onload=()=>{if(i.drawImage(u,0,s,o,d),s+=d,e===a.length-1){const t=r.toDataURL("image/png"),e=document.createElement("a");e.href=t,e.download="combined_visualization.png",e.click()}},u.onerror=t=>{console.error(`Error loading image ${e}:`,t)};const h=(new XMLSerializer).serializeToString(l),x=new Blob([h],{type:"image/svg+xml"}),g=URL.createObjectURL(x);u.src=g}))}
